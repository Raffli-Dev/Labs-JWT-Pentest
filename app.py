from flask import Flask, redirect, url_for, render_template, request, jsonify, make_response
import jwt
import datetime
from dotenv import load_dotenv
import os

load_dotenv()

app = Flask(__name__)

app.config['SECRET_KEY'] = os.getenv('SECRET_KEY')
app.config['PRIVATE_KEY'] = os.getenv('PRIVATE_KEY')
app.config['PUBLIC_KEY'] = os.getenv('PUBLIC_KEY')
app.config['JWT_ISSUER'] = os.getenv('JWT_ISSUER')
app.config['JWT_AUDIENCE'] = os.getenv('JWT_AUDIENCE')

@app.route('/', methods=['GET'])
def home():
    return render_template('index.html')

@app.route("/comment", methods=['GET', 'POST'])
def comment():
    if request.method == 'POST':
        comment = request.form['comment']
        
        token = jwt.encode({
            'Comment': 'This is A GOD X',  
            'role': 'role_user',       
            'iss': app.config['JWT_ISSUER'],
            'aud': app.config['JWT_AUDIENCE'],
            'exp': datetime.datetime.utcnow() + datetime.timedelta(minutes=5)
        }, app.config['PRIVATE_KEY'], algorithm="RS256")
        
        
        resp = make_response(render_template('comment.html', comment=comment))
        resp.set_cookie('session', token) 
        return resp

    
    token = request.cookies.get('session')
    if not token:
        return render_template('comment.html', comment="No JWT token found in cookies.")

    try:
        data = jwt.decode(token, app.config['PUBLIC_KEY'], algorithms=["RS256"],
                          issuer=app.config['JWT_ISSUER'], audience=app.config['JWT_AUDIENCE'])
        
        if data['role'] == 'role_admin':
            print("Flag: flag{BH283AssJJ_AssawqjdewdfJask}")
            return render_template('comment.html', comment="Administrator Access: You have the flag!")
    except jwt.ExpiredSignatureError:
        return render_template('comment.html', comment="Token has expired. Please submit a new comment.")
    except jwt.InvalidTokenError:
        return render_template('comment.html', comment="Invalid Token. Please try again.")
    
    return render_template('comment.html', comment="Welcome! You are a regular user.")

if __name__ == '__main__':
    app.run('0.0.0.0', port=5000, debug=True)
